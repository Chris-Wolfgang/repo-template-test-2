# Sequential PR validation workflow with coverage gating
# Stage 1: Linux tests with 90% coverage requirement
# Stage 2: Windows .NET Core and .NET Framework tests (only if Linux passes)
# Stage 3: macOS tests (only if Stage 2 passes)
#
# SECURITY NOTE:
# - Uses pull_request_target to run workflow from the trusted main branch, not from PR branch
# - This prevents malicious workflow modifications in untrusted PR branches
# - All checkout steps use repository + ref to support fork-based PRs
# - persist-credentials: false prevents the GitHub token from being available to PR code
# - Permissions are restricted to read-only access

name: PR Checks v3 (Gated)

permissions:
  contents: read
  
on:
  pull_request_target:  # Runs from the main branch, not from PR branch
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
jobs:
  # ============================================================================
  # STAGE 1: Linux - .NET Core/5+ Tests with Coverage Gate
  # ============================================================================
  test-linux-core: 
    name: "Stage 1: Linux Tests (.NET 5.0-10.0) + Coverage Gate"
    runs-on:  ubuntu-latest
    if: github.repository != 'Chris-Wolfgang/repo-template'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false

      # Fix for .NET 5.0 on Ubuntu 22.04+ - install libssl1.1
      - name: Install OpenSSL 1.1 for .NET 5.0
        run: |
          wget http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2_amd64.deb
          sudo dpkg -i libssl1.1_1.1.1f-1ubuntu2_amd64.deb

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            5.0.x
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Restore and build (exclude .NET Framework 4.x projects)
        run: |
          echo "Finding all projects in solution..."
          
          # Get list of all projects from solution file
          if [ -f "*.sln" ]; then
            sln_file=$(ls *.sln | head -n 1)
            echo "Using solution file: $sln_file"
          fi
          
          # Find all .csproj, .vbproj, and .fsproj files
          # Exclude those with 'dotnet4' or 'DotNet4' in the path (case-insensitive)
          projects=$(find . -type f \( -name "*.csproj" -o -name "*.vbproj" -o -name "*.fsproj" \) | grep -iv "dotnet4")
          
          if [ -z "$projects" ]; then
            echo "No projects found!"
            exit 1
          fi
          
          echo "=========================================="
          echo "Projects to build (excluding .NET Framework 4.x):"
          echo "=========================================="
          echo "$projects"
          echo ""
          
          # Restore each project
          echo "Restoring projects..."
          for proj in $projects; do
            echo "Restoring: $proj"
            dotnet restore "$proj" || exit 1
          done
          
          echo ""
          echo "Building projects..."
          # Build each project
          for proj in $projects; do
            echo "Building: $proj"
            dotnet build "$proj" --no-restore --configuration Release || exit 1
          done
          
          echo ""
          echo "‚úÖ All compatible projects built successfully"

      - name: Run tests with coverage (.NET Core 5.0 - 10.0)
        run: |
          # Find all test projects
          test_projects=$(find ./tests -type f -name "*.csproj")
          
          if [ -z "$test_projects" ]; then
            echo "‚ùå No test projects found in ./tests directory!"
            exit 1
          fi
          
          echo "=========================================="
          echo "Found test projects:"
          echo "=========================================="
          echo "$test_projects"
          echo ""
          
          # Test each framework individually to ensure all are tested
          frameworks=(net5.0 net6.0 net7.0 net8.0 net9.0 net10.0)
          
          for test_proj in $test_projects; do
            echo "=========================================="
            echo "Testing project: $test_proj"
            echo "=========================================="
            
            for fw in "${frameworks[@]}"; do
              echo "Testing framework: $fw"
              
              dotnet test "$test_proj" \
                --configuration Release \
                --framework "$fw" \
                --collect:"XPlat Code Coverage" \
                --results-directory "./TestResults" \
                --logger "console;verbosity=minimal" || exit 1
            done
            echo ""
          done

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate coverage report
        run: |
          reportgenerator \
            -reports:"TestResults/**/coverage.cobertura.xml" \
            -targetdir:"CoverageReport" \
            -reporttypes:"Html;TextSummary;MarkdownSummaryGithub;CsvSummary"

      - name: Enforce 90% coverage threshold
        run: |
          if [ ! -f CoverageReport/Summary.txt ]; then
            echo "‚ùå Coverage report not generated!"
            exit 1
          fi

          echo "Coverage Summary:"
          cat CoverageReport/Summary.txt
          echo ""
          
          failed_projects=""
          threshold=90
          
          while read -r line; do
            # Match lines with module names and percentages
            if echo "$line" | grep -qE '^[^ ].*[0-9]+%$' && ! echo "$line" | grep -q '^Summary'; then
              module=$(echo "$line" | awk '{print $1}')
              percent=$(echo "$line" | awk '{print $NF}' | tr -d '%')
              
              echo "Checking module: '$module' - Coverage: ${percent}%"
              
              if [ "$percent" -lt "$threshold" ]; then
                echo "  ‚ùå FAIL: Below ${threshold}% threshold"
                failed_projects="$failed_projects $module (${percent}%)"
              else
                echo "  ‚úÖ PASS: Meets ${threshold}% threshold"
              fi
            fi
          done < CoverageReport/Summary.txt

          if [ -n "$failed_projects" ]; then
            echo ""
            echo "=========================================="
            echo "‚ùå COVERAGE GATE FAILED"
            echo "=========================================="
            echo "Projects below ${threshold}% coverage: $failed_projects"
            echo ""
            echo "Stage 1 failed. Windows, macOS, and .NET Framework tests will NOT run."
            exit 1
          else
            echo ""
            echo "=========================================="
            echo "‚úÖ COVERAGE GATE PASSED"
            echo "=========================================="
            echo "All projects meet ${threshold}% coverage threshold."
            echo "Proceeding to Stage 2 (Windows and macOS tests)."
          fi

      - name: Upload Linux coverage results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-linux
          path: |
            TestResults/
            CoverageReport/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            src/**/bin/Release
            tests/**/bin/Release

  # ============================================================================
  # STAGE 2: Windows - .NET Core/5+ and .NET Framework Tests (Gated by Stage 1)
  # ============================================================================
  test-windows-core:
    name: "Stage 2a: Windows Tests (.NET 5.0-10.0)"
    runs-on: windows-latest
    needs: test-linux-core
    if: github.repository != 'Chris-Wolfgang/repo-template'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            5.0.x
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run tests (.NET Core 5.0 - 10.0)
        shell: pwsh
        run: |
          $testProjects = Get-ChildItem -Path './tests' -Recurse -Filter '*.csproj'
          
          if ($testProjects.Count -eq 0) {
            Write-Error "‚ùå No test projects found in ./tests directory!"
            exit 1
          }
          
          Write-Host "==========================================" -ForegroundColor Cyan
          Write-Host "Found test projects:" -ForegroundColor Cyan
          Write-Host "==========================================" -ForegroundColor Cyan
          $testProjects | ForEach-Object { Write-Host $_.FullName -ForegroundColor White }
          Write-Host ""
          
          $frameworks = @('net5.0', 'net6.0', 'net7.0', 'net8.0', 'net9.0', 'net10.0')
          
          foreach ($testProj in $testProjects) {
            Write-Host "==========================================" -ForegroundColor Cyan
            Write-Host "Testing project: $($testProj.FullName)" -ForegroundColor Cyan
            Write-Host "==========================================" -ForegroundColor Cyan
            
            foreach ($fw in $frameworks) {
              Write-Host "Testing framework:  $fw" -ForegroundColor Yellow
              
              dotnet test $testProj.FullName `
                --configuration Release `
                --framework $fw `
                --logger "console;verbosity=normal"
              
              if ($LASTEXITCODE -ne 0) {
                Write-Error "Tests failed for $fw in $($testProj.Name)"
                exit 1
              }
            }
            Write-Host ""
          }

  test-windows-framework: 
    name: "Stage 2b: Windows .NET Framework Tests (4.6.2-4.8.1)"
    runs-on: windows-latest
    needs: test-linux-core
    if: github.repository != 'Chris-Wolfgang/repo-template'
    
    steps: 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name:  Run .NET Framework tests (4.6.2 - 4.8.1)
        shell: pwsh
        run: |
          $testProjects = Get-ChildItem -Path './tests' -Recurse -Filter '*.csproj'
          
          if ($testProjects.Count -eq 0) {
            Write-Error "‚ùå No test projects found in ./tests directory!"
            exit 1
          }
          
          Write-Host "==========================================" -ForegroundColor Cyan
          Write-Host "Found test projects:" -ForegroundColor Cyan
          Write-Host "==========================================" -ForegroundColor Cyan
          $testProjects | ForEach-Object { Write-Host $_.FullName -ForegroundColor White }
          Write-Host ""
          
          $frameworks = @('net462', 'net472', 'net48', 'net481')
          
          foreach ($testProj in $testProjects) {
            Write-Host "==========================================" -ForegroundColor Cyan
            Write-Host "Testing project: $($testProj.FullName)" -ForegroundColor Cyan
            Write-Host "==========================================" -ForegroundColor Cyan
            
            foreach ($fw in $frameworks) {
              Write-Host "Testing framework: $fw" -ForegroundColor Yellow
              
              dotnet test $testProj.FullName `
                --configuration Release `
                --framework $fw `
                --logger "console;verbosity=normal"
              
              if ($LASTEXITCODE -ne 0) {
                Write-Error "Tests failed for $fw in $($testProj.Name)"
                exit 1
              }
            }
            Write-Host ""
          }

  # ============================================================================
  # STAGE 3: macOS Tests (Gated by Stage 2)
  # ============================================================================
  test-macos-core:
    name: "Stage 3: macOS Tests (.NET 6.0-10.0)"
    runs-on: macos-latest
    needs: [test-windows-core, test-windows-framework]
    if: github.repository != 'Chris-Wolfgang/repo-template'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Restore and build (exclude .NET Framework 4.x projects)
        run: |
          echo "Finding all projects in solution..."
          
          # Find all .csproj, .vbproj, and .fsproj files
          # Exclude those with 'dotnet4' or 'DotNet4' in the path (case-insensitive)
          projects=$(find . -type f \( -name "*.csproj" -o -name "*.vbproj" -o -name "*.fsproj" \) | grep -iv "dotnet4")
          
          if [ -z "$projects" ]; then
            echo "No projects found!"
            exit 1
          fi
          
          echo "=========================================="
          echo "Projects to build (excluding .NET Framework 4.x):"
          echo "=========================================="
          echo "$projects"
          echo ""
          
          # Restore each project
          echo "Restoring projects..."
          for proj in $projects; do
            echo "Restoring: $proj"
            dotnet restore "$proj" || exit 1
          done
          
          echo ""
          echo "Building projects..."
          # Build each project
          for proj in $projects; do
            echo "Building: $proj"
            dotnet build "$proj" --no-restore --configuration Release || exit 1
          done
          
          echo ""
          echo "‚úÖ All compatible projects built successfully"

      - name:  Run tests (.NET 6.0 - 10.0 only - ARM64 compatible)
        run: |
          # Find all test projects
          test_projects=$(find ./tests -type f -name "*.csproj")
          
          if [ -z "$test_projects" ]; then
            echo "‚ùå No test projects found in ./tests directory!"
            exit 1
          fi
          
          echo "=========================================="
          echo "Found test projects:"
          echo "=========================================="
          echo "$test_projects"
          echo ""
          
          # Skip .NET Core 5.0 and .NET 5.0 - no ARM64 support on macOS
          frameworks=(net6.0 net7.0 net8.0 net9.0 net10.0)
          
          for test_proj in $test_projects; do
            echo "=========================================="
            echo "Testing project: $test_proj"
            echo "=========================================="
            
            for fw in "${frameworks[@]}"; do
              echo "Testing framework: $fw"
              
              dotnet test "$test_proj" \
                --configuration Release \
                --framework "$fw" \
                --logger "console;verbosity=normal" || exit 1
            done
            echo ""
          done

      - name: Display macOS architecture info
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "‚ÑπÔ∏è  macOS Testing Notes"
          echo "=========================================="
          echo "Architecture: $(uname -m)"
          echo ""
          echo "Skipped frameworks (no ARM64 support):"
          echo "  - .NET 5.0 ‚ùå"
          echo ""
          echo "Tested frameworks (ARM64 compatible):"
          echo "  - .NET 6.0 ‚úÖ"
          echo "  - .NET 7.0 ‚úÖ"
          echo "  - .NET 8.0 ‚úÖ"
          echo "  - .NET 9.0 ‚úÖ"
          echo "  - .NET 10.0 ‚úÖ"
          echo ""
          echo ".NET Core 5.0 are tested on Linux and Windows"
          echo ""

      - name: Summarize pipeline result
        run: |
          echo "=========================================="
          echo "‚úÖ ALL STAGES PASSED"
          echo "=========================================="
          echo "Stage 1: Linux tests + 90% coverage ‚úÖ"
          echo "Stage 2: Windows .NET Core & .NET Framework tests ‚úÖ"
          echo "Stage 3: macOS tests ‚úÖ"
          echo ""
          echo "PR is ready to merge! üéâ"

  # ============================================================================
  # Security Scan (Runs in parallel with tests)
  # ============================================================================
  security-scan:
    name: "Security Scan (DevSkim)"
    runs-on: ubuntu-latest
    if: github.repository != 'Chris-Wolfgang/repo-template'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false

      - name: Install DevSkim CLI
        run: dotnet tool install --global Microsoft.CST.DevSkim.CLI

      - name: Run DevSkim security scan
        continue-on-error: true
        run: |
          devskim analyze \
            --source-code . \
            --file-format text \
            --output-file devskim-results.txt \
            -E \
            --ignore-rule-ids DS176209 \
            --ignore-globs "**/api/**,**/CoverageReport/**,**/TestResults/**"

      - name: Display security scan results
        if: always()
        run: |
          if [ -f devskim-results.txt ]; then
            echo "=========================================="
            echo "DevSkim Security Scan Results"
            echo "=========================================="
            cat devskim-results.txt
            echo ""
            
            if grep -qi "error\|critical\|high" devskim-results.txt; then
              echo "‚ö†Ô∏è Security issues detected - review required"
            else
              echo "‚úÖ No critical security issues found"
            fi
          else
            echo "‚úÖ No security issues found"
          fi

      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: devskim-results
          path: devskim-results.txt
          if-no-files-found: warn
